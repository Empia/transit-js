<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/com/cognitect/transit/impl/writer.js - transit-js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img width="100" src="../assets/css/cognitect.jpg">transit-js: src/com/cognitect/transit/impl/writer.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.8.770</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Modules</h2>
    </div>
    <div class="bd">
        <ul>
            
        </ul>
    </div>
</div>

<div id="classes" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Classes</h2>
    </div>
    <div class="bd">
        <ul>
            
                <li><a href="../classes/transit.html">transit</a></li>
            
        </ul>
    </div>
</div>










<div id="fileTree" class="sidebox">
    <div class="hd">
        <h2 class="no-toc">Files</h2>
    </div>
    <div class="bd">
        <ul><li>src/<ul><li>com/<ul><li>cognitect/<ul><li><a href="../files/src_com_cognitect_transit.js.html">transit.js</a></li><li>transit/<ul><li><a href="../files/src_com_cognitect_transit_caching.js.html">caching.js</a></li><li><a href="../files/src_com_cognitect_transit_delimiters.js.html">delimiters.js</a></li><li><a href="../files/src_com_cognitect_transit_eq.js.html">eq.js</a></li><li><a href="../files/src_com_cognitect_transit_handlers.js.html">handlers.js</a></li><li>impl/<ul><li><a href="../files/src_com_cognitect_transit_impl_decoder.js.html">decoder.js</a></li><li><a href="../files/src_com_cognitect_transit_impl_reader.js.html">reader.js</a></li><li><a href="../files/src_com_cognitect_transit_impl_writer.js.html">writer.js</a></li></ul></li><li><a href="../files/src_com_cognitect_transit_types.js.html">types.js</a></li><li><a href="../files/src_com_cognitect_transit_util.js.html">util.js</a></li></ul></li></ul></li></ul></li></ul></li></ul>
    </div>
</div>



        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>src/com/cognitect/transit/impl/writer.js</h4>

<pre class="code prettyprint linenums">
// Copyright 2014 Cognitect. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an &quot;AS-IS&quot; BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

goog.provide(&quot;com.cognitect.transit.impl.writer&quot;);
goog.require(&quot;com.cognitect.transit.util&quot;);
goog.require(&quot;com.cognitect.transit.caching&quot;);
goog.require(&quot;com.cognitect.transit.handlers&quot;);
goog.require(&quot;com.cognitect.transit.types&quot;);
goog.require(&quot;com.cognitect.transit.delimiters&quot;);
goog.require(&quot;goog.math.Long&quot;);

goog.scope(function() {

var writer   = com.cognitect.transit.impl.writer,
    util     = com.cognitect.transit.util,
    caching  = com.cognitect.transit.caching,
    handlers = com.cognitect.transit.handlers,
    types    = com.cognitect.transit.types,
    d        = com.cognitect.transit.delimiters,
    Long     = goog.math.Long;

writer.escape = function(string) {
    if(string.length &gt; 0) {
        var c = string.charAt(0);
        if(c === d.ESC || c === d.SUB || c === d.RES) {
            return d.ESC+string;
        } else {
            return string;
        }
    } else {
        return string;
    }
};

/**
 * @constructor
 */
writer.JSONMarshaller = function(opts) {
    this.opts = opts || {};
    this.preferStrings = this.opts[&quot;preferStrings&quot;] != null ? this.opts[&quot;preferStrings&quot;] : true;

    this.objectBuilder = this.opts[&quot;objectBuilder&quot;] || null;

    this.handlers = new handlers.Handlers();

    var optsHandlers = this.opts[&quot;handlers&quot;];
    if(optsHandlers) {
        if(util.isArray(optsHandlers) || !optsHandlers.forEach) {
            throw new Error(&quot;transit writer \&quot;handlers\&quot; option must be a map&quot;);
        }
        var self = this;
        optsHandlers.forEach(function(v, k) {
            if(k !== undefined) {
                self.handlers.set(k, v);
            } else {
                throw new Error(&quot;Cannot create handler for JavaScript undefined&quot;);
            }
        });
    }

    // Multiple JS context helper
    this.handlerForForeign = this.opts[&quot;handlerForForeign&quot;];

    this.unpack = this.opts[&quot;unpack&quot;] || function(x) {
        if(types.isArrayMap(x) &amp;&amp; x.backingMap === null) {
            return x._entries;
        } else {
            return false;
        }
    };

    this.verbose = (this.opts &amp;&amp; this.opts[&quot;verbose&quot;]) || false;
};

writer.JSONMarshaller.prototype.handler = function(obj) {
    var h = this.handlers.get(handlers.constructor(obj));

    if(h != null) {
        return h;
    } else {
        var tag = obj &amp;&amp; obj[&quot;transitTag&quot;];
        if(tag) {
            return this.handlers.get(tag)
        } else {
            return null;
        }
    }
};

writer.JSONMarshaller.prototype.registerHandler = function(ctor, handler) {
    this.handlers.set(ctor, handler);
};

writer.JSONMarshaller.prototype.emitNil = function(asMapKey, cache) {
    if(asMapKey) {
        return this.emitString(d.ESC, &quot;_&quot;, &quot;&quot;, asMapKey, cache);
    } else {
        return null;
    }
};

writer.JSONMarshaller.prototype.emitString = function(prefix, tag, s, asMapKey, cache) {
    var string = prefix+tag+s;
    if(cache) {
        return cache.write(string, asMapKey);
    } else {
        return string;
    }
};

writer.JSONMarshaller.prototype.emitBoolean = function(b, asMapKey, cache) {
    if(asMapKey) {
        var s = b.toString();
        return this.emitString(d.ESC, &quot;?&quot;, s[0], asMapKey, cache);
    } else {
        return b;
    }
};

writer.JSONMarshaller.prototype.emitInteger = function(i, asMapKey, cache) {
    if(i === Infinity) {
        return this.emitString(d.ESC, &quot;z&quot;, &quot;INF&quot;, asMapKey, cache);
    } else if(i === -Infinity) {
        return this.emitString(d.ESC, &quot;z&quot;, &quot;-INF&quot;, asMapKey, cache);
    } else if(isNaN(i)) {
        return this.emitString(d.ESC, &quot;z&quot;, &quot;NaN&quot;, asMapKey, cache);
    } else if(asMapKey || (typeof i === &quot;string&quot;) || (i instanceof Long)) {
        return this.emitString(d.ESC, &quot;i&quot;, i.toString(), asMapKey, cache);
    } else {
        return i;
    }
};

writer.JSONMarshaller.prototype.emitDouble = function(d, asMapKey, cache) {
    if(asMapKey) {
        return this.emitString(d.ESC, &quot;d&quot;, d, asMapKey, cache);
    } else {
        return d;
    }
};

writer.JSONMarshaller.prototype.emitBinary = function(b, asMapKey, cache) {
    return this.emitString(d.ESC, &quot;b&quot;, b, asMapKey, cache);
};

writer.JSONMarshaller.prototype.emitQuoted = function(em, obj, cache) {
    if(em.verbose) {
        var ret = {},
            k   = this.emitString(d.ESC_TAG, &quot;&#x27;&quot;, &quot;&quot;, true, cache);
        ret[k] = writer.marshal(this, obj, false, cache);
        return ret;
    } else {
        return [this.emitString(d.ESC_TAG, &quot;&#x27;&quot;, &quot;&quot;, true, cache), writer.marshal(this, obj, false, cache)];
    }
};

writer.emitObjects = function(em, iterable, cache) {
    var ret = [];
    if(util.isArray(iterable)) {
        for(var i = 0; i &lt; iterable.length; i++) {
            ret.push(writer.marshal(em, iterable[i], false, cache));
        }
    } else {
        iterable.forEach(function(v, i) {
            ret.push(writer.marshal(em, v, false, cache));
        });
    }
    return ret;
};

writer.emitArray = function(em, iterable, skip, cache) {
    return writer.emitObjects(em, iterable, cache);
};

writer.isStringableKey = function(em, k) {
    if(typeof k !== &quot;string&quot;) {
        var h = em.handler(k);
        return h &amp;&amp; h.tag(k).length === 1;
    } else {
        return true;
    }
};

writer.stringableKeys = function(em, obj) {
    var arr = em.unpack(obj),
        stringableKeys = true;

    if(arr) {
        for(var i = 0; i &lt; arr.length; i+=2) {
            stringableKeys = writer.isStringableKey(em, arr[i]);
            if(!stringableKeys) {
                break;
            }
        }
        return stringableKeys;
    } else if(obj.keys) {
        var iter = obj.keys(),
            step = null;

        if(iter.next) {
            step = iter.next();
            while(!step.done) {
                stringableKeys = writer.isStringableKey(em, step.value);
                if(!stringableKeys) {
                    break;
                }
                step = iter.next();
            }
            return stringableKeys;
        }
    }

    if(obj.forEach) {
        obj.forEach(function(v, k) {
            stringableKeys = stringableKeys &amp;&amp; writer.isStringableKey(em, k);
        });
        return stringableKeys;
    } else {
        throw new Error(&quot;Cannot walk keys of object type &quot; + handlers.constructor(obj).name);
    }
};

writer.isForeignObject = function(x) {
    if(x.constructor[&quot;transit$isObject&quot;]) {
        return true;
    }

    var ret = x.constructor.toString(),
        ret = ret.substr(&#x27;function &#x27;.length),
        ret = ret.substr(0, ret.indexOf(&#x27;(&#x27;)),
        isObject = ret == &quot;Object&quot;;

    if(typeof Object.defineProperty != &quot;undefined&quot;) {
        Object.defineProperty(x.constructor, &quot;transit$isObject&quot;, {
            value: isObject,
            enumerable: false
        });
    } else {
        x.constructor[&quot;transit$isObject&quot;] = isObject;
    }
    
    return isObject;
};

writer.emitMap = function(em, obj, skip, cache) {
    if((obj.constructor === Object) || 
       (obj.forEach != null) ||
       (em.handlerForForeign &amp;&amp; writer.isForeignObject(obj))) {
        if(em.verbose) {
            if(obj.forEach != null) {
                if(writer.stringableKeys(em, obj)) {
                    var ret = {};
                    obj.forEach(function(v, k) {
                        ret[writer.marshal(em, k, true, false)] = writer.marshal(em, v, false, cache);
                    });
                    return ret;
                } else {
                    var arr = em.unpack(obj),
                        rep = [],
                        tag = em.emitString(d.ESC_TAG, &quot;cmap&quot;, &quot;&quot;, true, cache);
                    if(arr) {
                        for(var i = 0; i &lt; arr.length; i+=2) {
                            rep.push(writer.marshal(em, arr[i], true, false));
                            rep.push(writer.marshal(em, arr[i+1], false, cache));
                        }
                    } else {
                        obj.forEach(function(v, k) {
                            rep.push(writer.marshal(em, k, true, false));
                            rep.push(writer.marshal(em, v, false, cache));
                        });
                    }
                    var ret = {};
                    ret[tag] = rep;
                    return ret;
                }
            } else {
                var ret = {},
                    ks  = util.objectKeys(obj);
                for(var i = 0; i &lt; ks.length; i++) {
                    ret[writer.marshal(em, ks[i], true, false)] = writer.marshal(em, obj[ks[i]], false, cache);
                }
                return ret;
            }
        } else {
            if(obj.forEach != null) {
                if(writer.stringableKeys(em, obj)) {
                    var arr = em.unpack(obj),
                        ret = [&quot;^ &quot;];
                    if(arr) {
                        for(var i = 0; i &lt; arr.length; i+=2) {
                            ret.push(writer.marshal(em, arr[i], true, cache));
                            ret.push(writer.marshal(em, arr[i+1], false, cache));
                        }
                    } else {
                        obj.forEach(function(v, k) {
                            ret.push(writer.marshal(em, k, true, cache));
                            ret.push(writer.marshal(em, v, false, cache));
                        });
                    }
                    return ret;
                } else {
                    var arr = em.unpack(obj),
                        rep = [],
                        tag = em.emitString(d.ESC_TAG, &quot;cmap&quot;, &quot;&quot;, true, cache);
                    if(arr) {
                        for(var i = 0; i &lt; arr.length; i+=2) {
                            rep.push(writer.marshal(em, arr[i], true, cache));
                            rep.push(writer.marshal(em, arr[i+1], false, cache));
                        }
                    } else {
                        obj.forEach(function(v, k) {
                            rep.push(writer.marshal(em, k, true, cache));
                            rep.push(writer.marshal(em, v, false, cache));
                        });
                    }
                    return [tag, rep];
                }
            } else {
                var ret = [&quot;^ &quot;],
                    ks  = util.objectKeys(obj);
                for(var i = 0; i &lt; ks.length; i++) {
                    ret.push(writer.marshal(em, ks[i], true, cache));
                    ret.push(writer.marshal(em, obj[ks[i]], false, cache));
                }
                return ret;
            }
        }
    } else if(em.objectBuilder != null) {
        return em.objectBuilder(obj, function(k) { return writer.marshal(em, k, true, cache);  },
                                     function(v) { return writer.marshal(em, v, false, cache); });
    } else {
        var name = handlers.constructor(obj).name,
            err  = new Error(&quot;Cannot write &quot; + name);
        err.data = {obj: obj, type: name};
        throw err;
    }
};

writer.emitTaggedMap = function(em, tag, rep, skip, cache) {
    if(em.verbose) {
        var ret = {};
        ret[em.emitString(d.ESC_TAG, tag, &quot;&quot;, true, cache)] = writer.marshal(em, rep, false, cache);
        return ret;
    } else {
        return [em.emitString(d.ESC_TAG, tag, &quot;&quot;, true, cache), writer.marshal(em, rep, false, cache)];
    }
};

writer.emitEncoded = function(em, h, tag, rep, obj, asMapKey, cache) {
    if(tag.length === 1) {
        if(typeof rep === &quot;string&quot;) {
            return em.emitString(d.ESC, tag, rep, asMapKey, cache);
        } else if(asMapKey || em.preferStrings) {
            var vh = em.verbose &amp;&amp; h.getVerboseHandler();
            if(vh) {
                tag = vh.tag(obj);
                rep = vh.stringRep(obj, vh);
            } else {
                rep = h.stringRep(obj, h);
            }
            if(rep !== null) {
                return em.emitString(d.ESC, tag, rep, asMapKey, cache);
            } else {
                var err = new Error(&quot;Tag \&quot;&quot;+tag+&quot;\&quot; cannot be encoded as string&quot;);
                err.data = {tag: tag, rep: rep, obj: obj};
                throw err;
            }
        } else {
            return writer.emitTaggedMap(em, tag, rep, asMapKey, cache);
        }
    } else {
        return writer.emitTaggedMap(em, tag, rep, asMapKey, cache);
    }
}

writer.marshal = function(em, obj, asMapKey, cache) {
    var h   = em.handler(obj) || (em.handlerForForeign ? em.handlerForForeign(obj, em.handlers) : null),
        tag = h ? h.tag(obj) : null,
        rep = h ? h.rep(obj) : null;

    if(h != null &amp;&amp; tag != null) {
        switch(tag) {
        case &quot;_&quot;:
            return em.emitNil(asMapKey, cache);
            break;
        case &quot;s&quot;:
            return em.emitString(&quot;&quot;, &quot;&quot;, writer.escape(rep), asMapKey, cache);
            break;
        case &quot;?&quot;:
            return em.emitBoolean(rep, asMapKey, cache);
            break;
        case &quot;i&quot;:
            return em.emitInteger(rep, asMapKey, cache);
            break;
        case &quot;d&quot;:
            return em.emitDouble(rep, asMapKey, cache);
            break;
        case &quot;b&quot;:
            return em.emitBinary(rep, asMapKey, cache);
            break;
        case &quot;&#x27;&quot;:
            return em.emitQuoted(em, rep, cache);
            break;
        case &quot;array&quot;:
            return writer.emitArray(em, rep, asMapKey, cache);
            break;
        case &quot;map&quot;:
            return writer.emitMap(em, rep, asMapKey, cache);
            break;
        default:
            return writer.emitEncoded(em, h, tag, rep, obj, asMapKey, cache);
            break;
        }
    } else {
        var name = handlers.constructor(obj).name,
            err = new Error(&quot;Cannot write &quot; + name);
        err.data = {obj: obj, type: name};
        throw err;
    }
};

writer.maybeQuoted = function(em, obj) {
    var h = em.handler(obj) || (em.handlerForForeign ? em.handlerForForeign(obj, em.handlers) : null);

    if(h != null) {
        if(h.tag(obj).length === 1) {
            return types.quoted(obj);
        } else {
            return obj;
        }
    } else {
        var name = handlers.constructor(obj).name,
            err  = new Error(&quot;Cannot write &quot; + name);
        err.data = {obj: obj, type: name};
        throw err;
    }
};

writer.marshalTop = function(em, obj, asMapKey, cache) {
    return JSON.stringify(writer.marshal(em, writer.maybeQuoted(em, obj), asMapKey, cache));
};

/**
 * @constructor
 */
writer.Writer = function(marshaller, options) {
    this._marshaller = marshaller;
    this.options = options || {};
    if(this.options[&quot;cache&quot;] === false) {
        this.cache = null;
    } else {
        this.cache = this.options[&quot;cache&quot;] ? this.options[&quot;cache&quot;] : new caching.WriteCache();
    }
};

writer.Writer.prototype.marshaller = function() {
    return this._marshaller;
};
writer.Writer.prototype[&quot;marshaller&quot;] = writer.Writer.prototype.marshaller;

writer.Writer.prototype.write = function(obj, opts) {
    var ret      = null,
        ropts    = opts || {},
        asMapKey = ropts[&quot;asMapKey&quot;] || false,
        cache    = this._marshaller.verbose ? false : this.cache;

    if(ropts[&quot;marshalTop&quot;] === false) {
        ret = writer.marshal(this._marshaller, obj, asMapKey, cache)
    } else {
        ret = writer.marshalTop(this._marshaller, obj, asMapKey, cache)
    }
    if(this.cache != null) {
        this.cache.clear();
    }
    return ret;
};
writer.Writer.prototype[&quot;write&quot;] = writer.Writer.prototype.write;

writer.Writer.prototype.register = function(type, handler) {
    this._marshaller.registerHandler(type, handler);
};
writer.Writer.prototype[&quot;register&quot;] = writer.Writer.prototype.register;

});

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
